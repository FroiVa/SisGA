{% extends 'base.html' %}
{% load static %}
{% block extra_head %}
    <link rel="stylesheet" type="text/css" href="{% static 'styles/datatables/datatables.min.css' %}">
    <link rel="stylesheet" type="text/css" href="{% static 'styles/datatables/dataTables.bootstrap5.min.css' %}"></link>
{% endblock %}
{% block title %}Gestión de Incidencias{% endblock %}

{% block content %}
    <div class="container-fluid">
        <div class="row">
            <div class="col-md-12">
                <!-- Header con estadísticas -->
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h1>
                        <i class="bi bi-clipboard-check"></i>
                        Gestión de Incidencias
                    </h1>
                </div>

                <!-- Tarjetas de estadísticas -->
                <div class="row mb-4">
                    <div class="col-md-3">
                        <div class="card bg-primary text-white">
                            <div class="card-body">
                                <div class="d-flex justify-content-between">
                                    <div>
                                        <h5 class="card-title">Total</h5>
                                        <h2 class="card-text">{{ total_incidencias }}</h2>
                                    </div>
                                    <div class="align-self-center">
                                        <i class="bi bi-clipboard-data fs-1"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card bg-success text-white">
                            <div class="card-body">
                                <div class="d-flex justify-content-between">
                                    <div>
                                        <h5 class="card-title">Hoy</h5>
                                        <h2 class="card-text">{{ incidencias_hoy }}</h2>
                                    </div>
                                    <div class="align-self-center">
                                        <i class="bi bi-calendar-day fs-1"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card bg-warning text-dark">
                            <div class="card-body">
                                <div class="d-flex justify-content-between">
                                    <div>
                                        <h5 class="card-title">Acciones</h5>
                                        <p class="card-text mb-0">Edición Masiva</p>
                                    </div>
                                    <div class="align-self-center">
                                        <i class="bi bi-pencil-square fs-1"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card bg-info text-white">
                            <div class="card-body">
                                <div class="d-flex justify-content-between">
                                    <div>
                                        <h5 class="card-title">Exportar</h5>
                                        <p class="card-text mb-0">Descargar CSV</p>
                                    </div>
                                    <div class="align-self-center">
                                        <i class="bi bi-download fs-1"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Filtros -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0">
                            Filtros de Búsqueda
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <form method="get" class="row g-3">
                                    <div class="col-md-5">
                                        {{ form_filtro.fecha_inicio.label_tag }}
                                        {{ form_filtro.fecha_inicio }}
                                    </div>
                                    <div class="col-md-5">
                                        {{ form_filtro.fecha_fin.label_tag }}
                                        {{ form_filtro.fecha_fin }}
                                    </div>
                                    <div class="col-12">
                                        <button type="submit" class="btn btn-primary">Filtrar</button>
                                        <a href="#" class="btn btn-secondary">
                                            <i class="bi bi-arrow-clockwise"></i> Limpiar
                                        </a>
                                        <a href="#"
                                           class="btn btn-outline-success">
                                            <i class="bi bi-download"></i> Exportar CSV
                                        </a>
                                    </div>
                                </form>
                            </div>
                            <div class="col-md-6 text-end">
                                <p class="text-muted">
                                    Mostrando del {{ fecha_inicio|date:"d/m/Y" }} al {{ fecha_fin|date:"d/m/Y" }}
                                </p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Tabla -->
                <div class="card">
                    <div class="card-header">
                        <div class="col-11">
                            <h2>Incidencias</h2>
                        </div>
                    </div>
                </div>
                <div class="card-body">

                    <div class="table-container">
                        <table id="incidenciasTable" class="table table-bordered">
                            <thead>
                            <tr>
                                <th class="text-center">Empleado</th>

                                {% for dia in dias %}
                                    <th class="text-center">{{ dia|date:"d/m" }}</th>
                                {% endfor %}
                                {#                        <th>Acciones</th>#}
                            </tr>
                            </thead>
                            <tbody>
                            {% for fila in tabla_datos %}
                                <tr>
                                    <td style="width: fit-content">
                                        <div class="row">
                                            <div>
                                                <h6>{{ fila.empleado }}</h6>
                                            </div>
                                        </div>
                                        <div class="row" style="font-size:x-small">
                                            <p>{{ fila.area }}</p>
                                        </div>
                                    </td>

                                    {% for dia in fila.dias %}

                                        <td>
                                            <form method="post"
                                                  action="{% url 'editar_incidencia' dia.incidencia_id %}">
                                                {% csrf_token %}
                                                <select name="estado" class="form-select" style="width: fit-content"
                                                        onchange="this.form.submit()">
                                                    {% for opcion in opciones_estado %}
                                                        <option value="{{ opcion.clave }}"
                                                                {% if dia.estado.clave == opcion.clave %}selected{% endif %}>
                                                            {{ opcion.clave_id }}

                                                        </option>

                                                    {% endfor %}
                                                </select>
                                            </form>
                                        </td>
                                    {% endfor %}
                                </tr>
                            {% endfor %}
                            </tbody>
                        </table>
                    </div>

                    {% if not tabla_datos %}
                        <div class="alert alert-info text-center">
                            No hay incidencias registradas en el período seleccionado.
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    </div>
{% endblock %}

{% block extra_js %}
    <!-- Incluir DataTables -->
    <script type="text/javascript" charset="utf8" src="{% static 'js/jquery-3.7.1.min.js' %}"></script>
    <script type="text/javascript" charset="utf8" src="{% static 'js/datatables/dataTables.js' %}"></script>

    <script>

        $(document).ready(function () {
            // Configuración básica de DataTable
            $('#incidenciasTable').DataTable({
                "language": {
                    "url": "{% static 'js/datatables/es-ES.json' %}"
                },
                "pageLength": 10, // Mostrar 15 registros por página
                "lengthMenu": [[10, 15, 25, 50, -1], [10, 15, 25, 50, "Todos"]], // Opciones de cantidad de registros
                "order": [], // Sin orden inicial
                "searching": true, // Habilitar búsqueda
                "info": true, // Mostrar información
                "paging": true, // Habilitar paginación
                "responsive": true, // Hacer la tabla responsive
                "autoWidth": false, // Desactivar autoWidth para mejor control
                "scrollX": true, // Para tablas con muchas columnas
            });
        });
    </script>
{% endblock %}